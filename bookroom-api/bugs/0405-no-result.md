## 智能助手规划的逻辑
智能助手的规划的逻辑是：docs/问答逻辑.md

## 目前的情况 (初始状态)
1. 智能助手会根据情况选择是否调用search_tool 【正确】
2. 如果智能助手选择search_tool，那么确实会得到网络搜索结果的数据 【正确】
3. 在前端界面可以设置"步数限制" 【正确】
4. 到达步数限制后，智能助手确实会被终止 【正确】
5. **无论是否需要，智能助手都会运行"步数限制" 指定的步数，即使可能已获得足够信息** 【错误】
6. **在最后一步应该输出整合后的答案，但 Agent 未能生成或输出最终的、整合后的答案给用户** 【错误】

## 问题复现

### 复现方法

```bash
# (根据实际情况，可能需要更新Token和Agent ID)
TEST_TOKEN='...' TEST_AGENT_ID='9f5389cc-affb-4715-befd-0a893a94feb3' pnpm test:jest -- test/integration/bugs/0405-no-result.test.ts
# 或通过前端界面进行测试，观察网络请求和最终输出
```

### 控制台输出
(待补充或参考之前的测试运行日志)

## 备注
1. Agent ID：9f5389cc-affb-4715-befd-0a893a94feb3
2. 此智能助手包含**主提示词**和**追加提示词**
**主提示词**：
```text
你是一个智能助手，可以根据用户的指令和自己的理解，选择合适的工具帮你完成任务。
你有以下工具可供使用： time_tool: API for curent time | 查询当前时间接口 search_tool: Search the web for information | 在网络上搜索信息
如果你不确定如何处理某个任务，可以询问用户寻求帮助。
如果某个工具连续返回错误信息或者无法完成任务，最高限制为5次尝试，超过次数后不再尝试该工具并提示用户该工具可能存在问题。
```
**追加提示词**
请注意，你的目标是高效地完成用户的任务。一旦你认为已经收集到足够的信息并得出了最终结论，就应该立即停止思考和工具调用，并整合所有信息，清晰地输出最终答案给用户。不要为了达到"步数限制"而执行不必要的步骤。在任务完成的最后，必须向用户展示最终的、整合后的答案。

## 解决方案规划 (重新开始)

**核心原则:**
1.  **最小化对共享代码 (`think.ts`) 的影响**: 优先新增而非修改。
2.  **深入理解需求**: 明确区分 Bug #5 (提前结束) 和 Bug #6 (输出最终答案) 的要求。
3.  **系统性解决**: 遵循"环境优先、逻辑其次、测试验证"的步骤。
4.  **清晰沟通**: 在进行可能影响他人的修改时，明确提出并讨论。

**修复计划:**

**阶段一：环境整治与基础准备**
*   **任务 1.1 (环境)**: 调查并修复测试环境中的 `ECONNREFUSED` 数据库连接错误和测试结束后的异步日志错误。
*   **任务 1.2 (基础)**:
    *   **分析**: `think.ts` 是共享模块，直接修改 `think.output` 有风险。
    *   **方案**: 在 `think.ts` 中**新增**方法 `finalAnswer(content: string)`，内部调用 `push` 并使用**新的 `eventType`** (如 `final_answer`)。
    *   **沟通**: 实施前需确认此方案。

**阶段二：实现最终答案逻辑 (解决 Bug #6 核心)**
*   **任务 2.1 (逻辑)**: 在 Agent 执行循环结束后，**新增**一步：收集关键历史，调用 LLM 进行最后整合，生成最终答案。
*   **任务 2.2 (输出)**: 使用新创建的 `think.finalAnswer()` 输出最终答案。
*   **测试**: 编写测试用例，断言需**严格检查** `event: final_answer` 及其内容。

**阶段三：实现提前结束逻辑 (解决 Bug #5 核心)**
*   **任务 3.1 (逻辑)**: 在 Agent 循环内部，**增加检查**：判断 LLM 响应是要求工具调用还是已给出最终答案。
*   **任务 3.2 (控制)**: 若是最终答案，则**提前跳出**循环，转到阶段二的最终答案生成逻辑。
*   **任务 3.3 (Prompt)**: 可能需要微调 Prompt 以鼓励 LLM 提前结束。
*   **测试**: 设计新测试（使用简单任务和高 `limitSteps`），断言需验证 a) 收到 `final_answer` b) 执行步数**小于** `limitSteps`。

**阶段四：健壮性测试与收尾**
*   **任务 4.1 (工具测试)**: 实现专门针对 `search_tool` 的稳定测试用例。
*   **任务 4.2 (回归)**: 确保所有相关测试稳定通过。
*   **任务 4.3 (验证)**: 请求前端或其他相关方进行集成验证。

## TODO
研究和分析上述情况中错误的部分。